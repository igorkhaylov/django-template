user nginx;
# user  root;
worker_processes auto;

pid /run/nginx.pid;


events {
    worker_connections 4096;
    multi_accept on;
}


http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    map $http_authorization $auth_present {
        default "present";
        "" "absent";
    }

    # === Request ID ===
    map $http_x_request_id $req_id {
        default $http_x_request_id;
        "" "$msec-$pid-$connection-$request_length";
    }
    proxy_set_header X-Request-ID $req_id;
    add_header X-Request-ID $req_id always;

    # escape=json — чтобы спец.символы не ломали JSON
    log_format json_main escape=json
    '{'
    '"@timestamp":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"x_forwarded_for":"$http_x_forwarded_for",'

    '"request_id":"$req_id",'
    '"auth_present":"$auth_present",'

    '"request_method":"$request_method",'
    '"status":$status,'
    '"body_bytes_sent":$body_bytes_sent,'
    '"bytes_sent":$bytes_sent,'
    '"referer":"$http_referer",'

    '"ua":"$http_user_agent",'
    '"cua":"$http_custom_user_agent",'
    '"scheme":"$scheme",'
    '"protocol":"$server_protocol",'
    '"host":"$host",'
    '"uri":"$uri",'
    '"args":"$args",'

    # полное время запроса
    '"request_time":$request_time,'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'

    # время ответа апстрима
    '"upstream_response_time":"$upstream_response_time",'
    '"upstream_connect_time":"$upstream_connect_time",'
    '"upstream_header_time":"$upstream_header_time"'
    '}';

    # уровни: debug|info|notice|warn|error|crit
    access_log /dev/stdout json_main;
    error_log /dev/stderr warn;

    sendfile on;

    keepalive_timeout 65;

    # В Docker Compose нужен встроенный DNS; в K8s — убрать resolver и 'resolve' в upstream.
    resolver 127.0.0.11 valid=5s ipv6=off;
    resolver_timeout 3s;

    # === UPSTREAMS ===
    # Upstream c разделяемым состоянием и пере-резолвом
    upstream django {
        zone django_zone 64k;
        server backend:8000 resolve max_fails=3 fail_timeout=30s;
        keepalive 32;
    }
    upstream minio_s3 {
        zone minio_s3_zone 64k;
        server minio:9000 resolve max_fails=3 fail_timeout=30s;
        keepalive 32;
    }
    upstream minio_console {
        zone minio_console_zone 64k;
        server minio:9001 resolve max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Правильная обработка Upgrade/Connection для WebSocket
    # Если заголовок Upgrade пуст — закрываем соединение, иначе — upgrade.
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # =========================================================
    # 1. Основной сайт (Django) - Порт 80
    # =========================================================
    server {
        listen 80;
        server_name _;

        client_max_body_size 500M;

        location ~ /\. {
            deny all;
        }

        location /static/ {
            root /app/;
            access_log off;
            expires 30d;
            add_header Cache-Control "public";
            try_files $uri =404;
        }

        location = /favicon.ico {
            root /app/static;
            access_log off;
            log_not_found off;
            add_header Cache-Control "public";
            expires 30d;
        }

        # # WebSocket endpoint
        # location /ws/ {
        #     # Обязательно HTTP/1.1 и Upgrade/Connection
        #     proxy_http_version 1.1;
        #     proxy_set_header Upgrade $http_upgrade;
        #     proxy_set_header Connection $connection_upgrade;

        #     # Базовые заголовки
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     # --- proxy_set_header only for the main proxy, otherwise it will be http --- #
        #     # proxy_set_header X-Forwarded-Proto $scheme;

        #     # WS не буферизуем, иначе лишняя задержка и «залипание»
        #     proxy_buffering off;

        #     # Таймауты под длительные WS-сессии
        #     proxy_connect_timeout 5s;
        #     proxy_send_timeout 600s;
        #     proxy_read_timeout 600s;

        #     # Дополнительно: при кратковременных сбоях делаем ретрай
        #     proxy_next_upstream error timeout http_502 http_503 http_504;
        #     proxy_next_upstream_tries 2;

        #     proxy_pass http://django;
        # }

        location / {
            proxy_redirect off;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # --- proxy_set_header only for the main proxy, otherwise it will be http --- #
            # proxy_set_header   X-Forwarded-Proto $scheme;

            proxy_connect_timeout 2s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;

            proxy_pass http://django;
        }
    }

    # =========================================================
    # 2. MinIO API
    # =========================================================
    server {
        listen 9000;
        http2 on; # MinIO любит HTTP/2
        server_name _;

        client_max_body_size 0; # Отключаем лимит для S3
        ignore_invalid_headers off;
        proxy_buffering off;
        proxy_request_buffering off;

        # =========================================================
        # MinIO API (S3) - Порт 9000
        # =========================================================
        location / {
            proxy_pass http://minio_s3;

            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 300;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
        }


        # =========================================================
        # MinIO Console (UI) - Порт 9001
        # =========================================================
        location /minio/ui/ {
            rewrite ^/minio/ui/(.*) /$1 break;
            proxy_pass http://minio_console;

            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-NginX-Proxy true;

            # WebSockets для консоли (важно!)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }

}
