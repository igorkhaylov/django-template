name: django-template


x-backend-defaults: &backend-defaults
  build:
    context: .
    dockerfile: ./.docker/backend/Dockerfile
  env_file:
    - ./.env
  volumes:
    - django-static:/app/static
    - django-media:/app/media
  depends_on:
    db:
      condition: service_healthy
    redis:
      condition: service_healthy
  restart: unless-stopped


services:
  backend:
    <<: *backend-defaults
    expose:
      - 8000
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/healthcheck/ || exit 1"]
      # test: ["CMD-SHELL", "curl -f -s -o /dev/null -w '%{http_code}' http://localhost:8000 | grep -q '200' && curl -s http://localhost:8000 | grep -q '{\"status\": \"ok\"}' || exit 1"]
      interval: 30s
      retries: 3
      start_period: 10s
      timeout: 5s
    command: bash scripts/entrypoint.sh
    restart: unless-stopped

  redis:
    image: redis:8
    expose:
      - 6379
    volumes:
      - redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      retries: 5
      timeout: 3s
    restart: unless-stopped

  db:
    image: postgres:17.4
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    expose:
      - 5432
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "sh -c 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}'" ]
      # test: [ "CMD", "pg_isready", "-U", "${POSTGRES_USER}", "-d", "${POSTGRES_DB}" ]
      interval: 5s
      retries: 5
      timeout: 5s
    deploy:
      resources:
        limits:
          memory: "256m"
    restart: unless-stopped


  nginx:
    image: nginx:stable-alpine
    ports:
      - "8050:80"
    volumes:
      - ./.docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - django-static:/app/static:ro
      - django-media:/app/media:ro
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped



volumes:
  postgres-data:
  redis-data:
  django-static:
  django-media:


##################################################################################################

# services:
#   minio:
#     image: "quay.io/minio/minio:${MINIO_TAG}"
#     command: server --console-address ":9001" /data
#     networks:
#       minio-net:
#     expose:
#       - "9000"
#       - "9001"
#     volumes:
#       - minio_data:/data
#     environment:
#       MINIO_ROOT_USER: ${MINIO_ROOT_USER}
#       MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
#       MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL}
#     healthcheck:
#       test: [ "CMD", "mc", "ready", "local" ]
#       interval: 5s
#       timeout: 5s
#       retries: 5
#     restart: unless-stopped
